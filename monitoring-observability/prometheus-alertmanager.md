# Prometheus + Alertmanager

> **Type**: Docker container (in LXC 149 `prom-graf`)  
> **Category**: Monitoring & Observability  
> **Role**: Time-series metrics collection and alerting for infrastructure and services

---

## üß© Overview

Prometheus collects metrics from Proxmox, containers, and servers using `node_exporter`.  
Alertmanager handles alerts generated by Prometheus and forwards critical or warning-level events to a Telegram chat.

This service runs in the same container as Grafana, but is documented separately for clarity.

---

## ‚öôÔ∏è Prometheus Configuration

### Scrape Settings

| Parameter           | Value    |
|---------------------|----------|
| `scrape_interval`   | 15s      |
| `evaluation_interval` | 15s   |

### Scrape Targets

| Job name         | Target IP           | Notes               |
|------------------|---------------------|---------------------|
| `prometheus`     | `localhost:9090`    | Self-monitoring     |
| `proxmox-node`   | `192.168.8.*:9100` | Proxmox host        |
| `adguard-node`   | `192.168.8.100:9100`| AdGuard LXC         |
| `media-server-node` | `192.168.8.102:9100` | Media server VM  |
| `cloud-node`     | `192.168.8.104:9100`| Cloud VM            |

Additional targets can be added if needed.

Rules are defined in separate YAML files under `rules/*.yml`.

---

## üì¢ Alertmanager Configuration

### Routing

- **Critical** alerts:
  - Receiver: `telegram`
  - Repeat: every 30 minutes
- **Warning** alerts:
  - Receiver: `telegram`
  - Repeat: every 3 hours
- All alerts:
  - Group wait: 10s
  - Group interval: 1m
  - Global repeat interval: 1h

### Telegram Integration

| Setting         | Value                |
|-----------------|----------------------|
| Bot Token       | Secret     |
| Chat ID         | `***`          |
| Parse Mode      | HTML                 |
| Resolved Alerts | Sent                 |

Alerts are sent with a custom message template including time, severity, instance, and annotations.

### Inhibition Rules

If a `critical` alert is active for a given alertname/instance, `warning` alerts with the same labels will be suppressed.

---

## üóÉÔ∏è Storage & Volumes

Prometheus and Alertmanager store their data in persistent Docker volumes within the container, typically mounted from:

- `/opt/prometheus/`
- `/opt/alertmanager/`

Rule files and configurations are manually maintained.

---

## üìù Notes

- Metrics are visualized in Grafana (see `grafana.md`)
- `node_exporter` must be installed on all target machines
- Prometheus listens on port `9090`, Alertmanager on `9093`
- Config files:
  - `prometheus.yml`
  - `rules/*.yml`
  - `alertmanager.yml`
